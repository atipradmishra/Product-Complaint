{% extends 'base.html' %}
{% block title %}HTO Complaint Report{% endblock %}

{% block content %}
<div class="ml-64 p-6">
  <!-- Header and Summary -->
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Complaint Analysis Dashboard</h1>
    <div class="text-sm text-gray-500">{{ now() }}</div>
  </div>

  <!-- AI Summary Placeholder -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <p><strong>AI Summary:</strong> This dashboard summarizes visualized insights based on dynamic configuration provided by the user.</p>
  </div>

  <!-- Dynamic Chart Blocks -->
  {% for chart in chart_configs %}
  <div class="bg-white p-4 rounded-lg shadow mb-6 h-96">
    <h2 class="font-bold text-sm mb-2">{{ chart.chart_title }}</h2>
    <canvas id="chart_{{ loop.index }}" class="w-full h-full"></canvas>
  </div>
  {% endfor %}

  <!-- Analyst Copilot Section -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="font-bold text-sm mb-4">Analyst Copilot</h2>
    <form action="/chat-with-rag" method="GET" class="flex items-start justify-center gap-2 mb-4">
      <textarea 
        name="prefill" 
        rows="1" 
        class="w-3/4 border p-2 rounded text-sm resize-none" 
        placeholder="Ask a question about complaint trends..."></textarea>
      <button 
        type="submit" 
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm whitespace-nowrap">
        Ask
      </button>
    </form>
    <div class="flex gap-2 flex-wrap justify-center">
      <button class="bg-gray-200 px-3 py-1 rounded text-sm">Compare sites</button>
      <button class="bg-gray-200 px-3 py-1 rounded text-sm">Product family trend</button>
      <button class="bg-gray-200 px-3 py-1 rounded text-sm">Monthly distribution</button>
      <button class="bg-gray-200 px-3 py-1 rounded text-sm">Root cause analysis</button>
    </div>
  </div>
</div>

<!-- Chart Data (Safe JSON from Jinja) -->
<script id="chart-data" type="application/json">
  {{ chart_data_json | safe }}
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const rawData = document.getElementById("chart-data").textContent;
  console.log("ðŸ“¦ Raw chart data string:", rawData); // ðŸ‘ˆ Check if this looks like JSON
  const chartConfigs = JSON.parse(rawData);
  console.log("âœ… Parsed chartConfigs:", chartConfigs); // ðŸ‘ˆ Should be an array

  chartConfigs.forEach((cfg, index) => {
    const ctx = document.getElementById(`chart_${index + 1}`).getContext("2d");
    new Chart(ctx, {
      type: cfg.chart_type,
      data: {
        labels: cfg.labels,
        datasets: [{
          label: cfg.metric_label || 'Value',
          data: cfg.data,
          backgroundColor: cfg.backgroundColor || 'rgba(54, 162, 235, 0.7)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: cfg.chart_type !== 'bar' },
          tooltip: { enabled: true }
        },
        scales: ['bar', 'line'].includes(cfg.chart_type) ? {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        } : {}
      }
    });
  });
</script>
{% endblock %}
